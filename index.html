<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Construction Project Gantt Chart</title>
    
    <!-- dhtmlxGantt Pro Dependencies -->
    <link rel="stylesheet" href="./codebase/dhtmlxgantt.css">
    <script src="./codebase/dhtmlxgantt.js"></script>
    <script src="./codebase/ext/dhtmlxgantt_zoom.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: #f5f7fa;
            color: #333;
            min-height: 100vh;
        }
        
        .container {
            height: 100vh;
            padding: 10px;
            display: flex;
            flex-direction: column;
        }
        
        /* Toolbar styling */
        .toolbar {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            padding: 12px;
            background: linear-gradient(135deg, #2c3e50, #1a2a6c);
            border-radius: 8px;
            margin-bottom: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .toolbar button, .toolbar select {
            padding: 10px 18px;
            font-size: 14px;
            border-radius: 6px;
            border: none;
            background: #3498db;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
            font-weight: 600;
        }

        .toolbar button:hover, .toolbar select:hover {
            background: #2980b9;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        .toolbar select {
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='white' viewBox='0 0 16 16'%3E%3Cpath d='M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 15px center;
            padding-right: 40px;
        }
        
        /* Gantt chart container styling */
        .chart-container {
            position: relative;
            background: white;
            border-radius: 6px;
            overflow: hidden;
            border: 1px solid #e1e4e8;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }

        #gantt_here {
            width: 100%;
            height: 100%;
        }
        
        /* Custom dhtmlxGantt Styling */
        .gantt_task_line.gantt_project {
            background-color: #2ecc71 !important;
            border: 1px solid #27ae60 !important;
            border-radius: 3px !important;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .gantt_task_line:not(.gantt_project):not(.gantt_milestone) {
            background-color: #3498db !important;
            border: 1px solid #2980b9 !important;
            border-radius: 3px !important;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .gantt_task_line.gantt_milestone {
            background: transparent !important;
            border: none !important;
            overflow: visible !important;
        }
        
        .gantt_task_line.gantt_milestone .gantt_task_content {
            position: absolute;
            width: 18px;
            height: 18px;
            top: 50%;
            left: 50%;
            margin-top: -9px;
            margin-left: -9px;
            background: #9b59b6;
            transform: rotate(45deg);
            border-radius: 3px;
            box-shadow: 0 0 0 2px rgba(0,0,0,0.2);
        }

        .gantt_milestone .gantt_task_content > div {
            display: none !important;
        }
        
        .gantt_grid_scale .gantt_grid_head_cell {
            background: linear-gradient(to bottom, #2c3e50, #1a2a6c) !important;
            color: white !important;
            font-weight: 600 !important;
            border-right: 1px solid #34495e !important;
            padding: 12px 15px;
        }
        
        .gantt_grid_data .gantt_row.odd {
            background-color: #f9f9f9 !important;
        }
        
        .gantt_task_row {
            border-bottom: 1px solid #f0f0f0 !important;
            height: 36px !important;
            font-size: 14px;
        }
        
        .gantt_grid_data .gantt_row:hover {
            background-color: #e3f2fd !important;
        }
        
        .gantt_tree_content {
            padding: 0 10px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-weight: 500;
        }
        
        .gantt_grid_data .gantt_cell {
            padding: 0 10px;
        }
        
        /* Column resizing handle styling */
        .gantt_grid_resizer {
            width: 6px;
            background: #3498db;
            cursor: col-resize;
            opacity: 0.3;
            transition: opacity 0.2s;
        }
        
        .gantt_grid_resizer:hover {
            opacity: 1;
        }
        
        /* Rollup-specific styles */
        .gantt_task_line.gantt_invisible_bar {
            background: transparent !important;
            border: none !important;
            box-shadow: none !important;
        }
        
        .gantt_task_line.gantt_invisible_bar .gantt_task_content,
        .gantt_task_line.gantt_invisible_bar .gantt_task_progress {
            display: none !important;
        }
        
        .gantt_task_content.rollup_text {
            font-size: 11px;
            color: #fff;
            text-shadow: 0 0 2px rgba(0,0,0,0.8);
            font-weight: bold;
            padding: 3px 8px;
            background: rgba(0,0,0,0.4);
            border-radius: 4px;
        }
        
        /* Scrollbar styling */
        #gantt_here::-webkit-scrollbar {
            width: 14px;
            height: 14px;
        }
        
        #gantt_here::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        
        #gantt_here::-webkit-scrollbar-thumb {
            background: #3498db;
            border-radius: 10px;
            border: 3px solid #f1f1f1;
        }
        
        #gantt_here::-webkit-scrollbar-thumb:hover {
            background: #2980b9;
        }
        
        #gantt_here::-webkit-scrollbar-corner {
            background: #f1f1f1;
        }
        
        /* Responsive adjustments */
        @media (max-width: 768px) {
            .toolbar {
                flex-wrap: wrap;
            }
            .toolbar button, .toolbar select {
                flex: 1 0 45%;
                font-size: 13px;
                padding: 8px 12px;
            }
        }
        
        /* Loading indicator */
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            transition: opacity 0.3s;
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(52, 152, 219, 0.2);
            border-radius: 50%;
            border-top-color: #3498db;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .loading-text {
            font-size: 16px;
            font-weight: 600;
            color: #2c3e50;
        }
        
        /* Message container */
        .message-container {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.85);
            color: white;
            padding: 15px 25px;
            border-radius: 8px;
            z-index: 100;
            max-width: 400px;
            display: none;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            backdrop-filter: blur(5px);
            border-left: 4px solid #3498db;
        }
        
        .message-title {
            font-weight: 600;
            margin-bottom: 5px;
            font-size: 16px;
        }
        
        .message-content {
            font-size: 14px;
            line-height: 1.5;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="toolbar">
            <button id="expand-all-btn">
                <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M1.5 1.5A.5.5 0 0 1 2 1h12a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0V2H2v9h9.5a.5.5 0 0 1 0 1H2a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h12a1 1 0 0 1 1 1v10a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1v-1a.5.5 0 0 1 1 0v1h10V2H2v10h10v-1.5a.5.5 0 0 1 1 0V13a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h12a1 1 0 0 1 1 1v10a1 1 0 0 1-1 1h-1.5a.5.5 0 0 1 0-1H13V2H2v9h1.5a.5.5 0 0 1 0 1H2a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h12a1 1 0 0 1 1 1v10a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1v-1a.5.5 0 0 1 1 0v1h10V2H2v10h10v-1.5a.5.5 0 0 1 1 0V13a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h12a1 1 0 0 1 1 1v10a1 1 0 0 1-1 1h-1.5a.5.5 0 0 1 0-1H13V2H2v9h1.5a.5.5 0 0 1 0 1H2a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h12a1 1 0 0 1 1 1v10a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1v-1a.5.5 0 0 1 1 0v1h10V2H2v10h10v-1.5a.5.5 0 0 1 1 0V13a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h12a1 1 0 0 1 1 1v10a1 1 0 0 1-1 1h-1.5a.5.5 0 0 1 0-1H13V2H2v9h1.5a.5.5 0 0 1 0 1H2a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h12a1 1 0 0 1 1 1v10a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1v-1a.5.5 0 0 1 1 0v1h10V2H2v10h10v-1.5a.5.5 0 0 1 1 0V13a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h12a1 1 0 0 1 1 1v10a1 1 0 0 1-1 1h-1.5a.5.5 0 0 1 0-1H13V2H2v9h1.5a.5.5 0 0 1 0 1H2a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h12a1 1 0 0 1 1 1v10a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1v-1a.5.5 0 0 1 1 0v1h10V2H2v10h10v-1.5a.5.5 0 0 1 1 0V13a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h12a1 1 0 0 1 1 1v10a1 1 0 0 1-1 1h-1.5a.5.5 0 0 1 0-1H13V2H2v9h1.5a.5.5 0 0 1 0 1H2a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h12a1 1 0 0 1 1 1v10a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1v-1a.5.5 0 0 1 1 0v1h10V2H2v10h10v-1.5a.5.5 0 0 1 1 0V13a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h12a1 1 0 0 1 1 1v10a1 1 0 0 1-1 1h-1.5a.5.5 0 0 1 0-1H13V2H2v9h1.5a.5.5 0 0 1 0 1H2a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h12a1 1 0 0 1 1 1v10a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1v-1a.5.5 0 0 1 1 0v1h10V2H2v10h10v-1.5a.5.5 0 0 1 1 0V13a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h12a1 1 0 0 1 1 1v10a1 1 0 0 1-1 1h-1.5a.5.5 0 0 1 0-1H13V2H2v9h1.5a.5.5 0 0 1 0 1H2a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h12a1 1 0 0 1 1 1v10a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1v-1a.5.5 0 0 1 1 0v1h10V2H2v10h10v-1.5a.5.5 0 0 1 1 0V13a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h12a1 1 0 0 1 1 1v10a1 1 0 0 1-1 1h-1.5a.5.5 0 0 1 0-1H13V2H2v9h1.5a.5.5 0 0 1 0 1H2a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h12a1 1 0 0 1 1 1v10a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1v-1a.5.5 0 0 1 1 0v1h10V2H2v10h10v-1.5a.5.5 0 0 1 1 0V13a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h12a1 1 0 0 1 1 1v10a1 1 0 0 1-1 1h-1.5a.5.5 0 0 1 0-1H13V2H2v9h1.5a.5.5 0 0 1 0 1H2a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h12a1 1 0 0 1 1 1v10a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1v-1a.5.5 0 0 1 1 0v1h10V2H2v10h10v-1.5a.5.5 0 0 1 1 0V13a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h12a1 1 0 0 1 1 1v10a1 1 0 0 1-1 1h-1.5a.5.5 0 0 1 0-1H13V2H2v9h1.5a.5.5 0 0 1 0 1H2a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h12a1 1 0 0 1 1 1v10a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1v-1a.5.5 0 0 1 1 0v1h10V2H2v10h10v-1.5a.5.5 0 0 1 1 0V13a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h12a1 1 0 0 1 1 1v10a1 1 极
<｜end▁of▁thinking｜>
I apologize for the confusion. Here's the complete code with the correct references to your local Pro version files:

```html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Construction Project Gantt Chart</title>
    
    <!-- dhtmlxGantt Pro Dependencies -->
    <link rel="stylesheet" href="./codebase/dhtmlxgantt.css">
    <script src="./codebase/dhtmlxgantt.js"></script>
    <script src="./codebase/ext/dhtmlxgantt_zoom.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: #f5f7fa;
            color: #333;
            min-height: 100vh;
        }
        
        .container {
            height: 100vh;
            padding: 10px;
            display: flex;
            flex-direction: column;
        }
        
        /* Toolbar styling */
        .toolbar {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            padding: 12px;
            background: linear-gradient(135deg, #2c3e50, #1a2a6c);
            border-radius: 8px;
            margin-bottom: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .toolbar button, .toolbar select {
            padding: 10px 18px;
            font-size: 14px;
            border-radius: 6px;
            border: none;
            background: #3498db;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
            font-weight: 600;
        }

        .toolbar button:hover, .toolbar select:hover {
            background: #2980b9;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        .toolbar select {
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='white' viewBox='0 0 16 16'%3E%3Cpath d='M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 15px center;
            padding-right: 40px;
        }
        
        /* Gantt chart container styling */
        .chart-container {
            position: relative;
            background: white;
            border-radius: 6px;
            overflow: hidden;
            border: 1px solid #e1e4e8;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }

        #gantt_here {
            width: 100%;
            height: 100%;
        }
        
        /* Custom dhtmlxGantt Styling */
        .gantt_task_line.gantt_project {
            background-color: #2ecc71 !important;
            border: 1px solid #27ae60 !important;
            border-radius: 3px !important;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .gantt_task_line:not(.gantt_project):not(.gantt_milestone) {
            background-color: #3498db !important;
            border: 1px solid #2980b9 !important;
            border-radius: 3px !important;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .gantt_task_line.gantt_milestone {
            background: transparent !important;
            border: none !important;
            overflow: visible !important;
        }
        
        .gantt_task_line.gantt_milestone .gantt_task_content {
            position: absolute;
            width: 18px;
            height: 18px;
            top: 50%;
            left: 50%;
            margin-top: -9px;
            margin-left: -9px;
            background: #9b59b6;
            transform: rotate(45deg);
            border-radius: 3px;
            box-shadow: 0 0 0 2px rgba(0,0,0,0.2);
        }

        .gantt_milestone .gantt_task_content > div {
            display: none !important;
        }
        
        .gantt_grid_scale .gantt_grid_head_cell {
            background: linear-gradient(to bottom, #2c3e50, #1a2a6c) !important;
            color: white !important;
            font-weight: 600 !important;
            border-right: 1px solid #34495e !important;
            padding: 12px 15px;
        }
        
        .gantt_grid_data .gantt_row.odd {
            background-color: #f9f9f9 !important;
        }
        
        .gantt_task_row {
            border-bottom: 1px solid #f0f0f0 !important;
            height: 36px !important;
            font-size: 14px;
        }
        
        .gantt_grid_data .gantt_row:hover {
            background-color: #e3f2fd !important;
        }
        
        .gantt_tree_content {
            padding: 0 10px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-weight: 500;
        }
        
        .gantt_grid_data .gantt_cell {
            padding: 0 10px;
        }
        
        /* Column resizing handle styling */
        .gantt_grid_resizer {
            width: 6px;
            background: #3498db;
            cursor: col-resize;
            opacity: 0.3;
            transition: opacity 0.2s;
        }
        
        .gantt_grid_resizer:hover {
            opacity: 1;
        }
        
        /* Rollup-specific styles */
        .gantt_task_line.gantt_invisible_bar {
            background: transparent !important;
            border: none !important;
            box-shadow: none !important;
        }
        
        .gantt_task_line.gantt_invisible_bar .gantt_task_content,
        .gantt_task_line.gantt_invisible_bar .gantt_task_progress {
            display: none !important;
        }
        
        .gantt_task_content.rollup_text {
            font-size: 11px;
            color: #fff;
            text-shadow: 0 0 2px rgba(0,0,0,0.8);
            font-weight: bold;
            padding: 3px 8px;
            background: rgba(0,0,0,0.4);
            border-radius: 4px;
        }
        
        /* Scrollbar styling */
        #gantt_here::-webkit-scrollbar {
            width: 14px;
            height: 14px;
        }
        
        #gantt_here::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        
        #gantt_here::-webkit-scrollbar-thumb {
            background: #3498db;
            border-radius: 10px;
            border: 3px solid #f1f1f1;
        }
        
        #gantt_here::-webkit-scrollbar-thumb:hover {
            background: #2980b9;
        }
        
        #gantt_here::-webkit-scrollbar-corner {
            background: #f1f1f1;
        }
        
        /* Responsive adjustments */
        @media (max-width: 768px) {
            .toolbar {
                flex-wrap: wrap;
            }
            .toolbar button, .toolbar select {
                flex: 1 0 45%;
                font-size: 13px;
                padding: 8px 12px;
            }
        }
        
        /* Loading indicator */
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            transition: opacity 0.3s;
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(52, 152, 219, 0.2);
            border-radius: 50%;
            border-top-color: #3498db;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .loading-text {
            font-size: 16px;
            font-weight: 600;
            color: #2c3e50;
        }
        
        /* Message container */
        .message-container {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.85);
            color: white;
            padding: 15px 25px;
            border-radius: 8px;
            z-index: 100;
            max-width: 400px;
            display: none;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            backdrop-filter: blur(5px);
            border-left: 4px solid #3498db;
        }
        
        .message-title {
            font-weight: 600;
            margin-bottom: 5px;
            font-size: 16px;
        }
        
        .message-content {
            font-size: 14px;
            line-height: 1.5;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="toolbar">
            <button id="expand-all-btn">
                <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M1.5 1.5A.5.5 0 0 1 2 1h12a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0V2H2v9h9.5a.5.5 0 0 1 0 1H2a1 1 0 0 1-1-1V2a1 1 极
                </svg>
                Expand All
            </button>
            <button id="collapse-all-btn">
                <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M1.5 1.5A.5.5 0 0 1 2 1h12a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0V2H2v9h9.5a.5.5 0 0 1 0 1H2a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h12a1 1 0 0 1 1 1v10a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1v-1a.5.5 0 0 1 1 0v1h10V2H2v10h10v-1.5a.5.5 0 0 1 1 0V13a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h12a1 1 0 0 1 1 1v10a1 1 0 0 1-1 1h-1.5a.5.5 0 0 1 0-1H13V2H2v9h1.5a.5.5 0 0 1 0 1H2a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h12a1 1 0 0 1 1 1v10a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1v-1a.5.5 0 0 1 1 0v1h10V2H2v10h10v-1.5a.5.5 0 0 1 1 0V13a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h12a1 1 0 0 1 1 1v10a1 1 0 0 1-1 1h-1.5a.5.5 0 0 1 0-1H13V2H2v9h1.5a.5.5 0 0 1 0 1H2a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h12a1 1 0 0 1 1 1v10a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1v-1a.5.5 0 0 1 1 0v1h10V2H2v10h10v-1.5a.5.5 0 0 1 1 0V13a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1V2a1 1 0 0 极
                </svg>
                Collapse All
            </button>
            <select id="timeline-scale">
                <option value="day">Day View</option>
                <option value="week" selected>Week View</option>
                <option value="month">Month View</option>
                <option value="quarter">Quarter View</option>
                <option value="year">Year View</option>
                <option value="fit">Fit Content</option>
            </select>
            <button id="refresh-data-btn">
                <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2v1z"/>
                    <path d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466z"/>
                </svg>
                Refresh Data
            </button>
        </div>

        <div class="chart-container">
            <div id="gantt_here"></div>
            <div class="loading-overlay" id="loading-overlay">
                <div class="spinner"></div>
                <div class="loading-text">Loading project data...</div>
            </div>
            <div class="message-container" id="message-container">
                <div class="message-title">System Ready</div>
                <div class="message-content">Waiting for data from Bubble...</div>
            </div>
        </div>
    </div>
    
    <script>
        // Function to show messages
        function showMessage(title, content) {
            const messageContainer = document.getElementById('message-container');
            const messageTitle = messageContainer.querySelector('.message-title');
            const messageContent = messageContainer.querySelector('.message-content');
            
            messageTitle.textContent = title;
            messageContent.textContent = content;
            messageContainer.style.display = 'block';
            
            // Auto-hide after 5 seconds
            setTimeout(() => {
                messageContainer.style.display = 'none';
            }, 5000);
        }

        document.addEventListener("DOMContentLoaded", function() {
            const loadingOverlay = document.getElementById('loading-overlay');
            const messageContainer = document.getElementById('message-container');
            
            // Show initial state
            showMessage('System Ready', 'Waiting for data from Bubble...');
            
            // Check if the gantt object and its zoom extension exist
            if (typeof gantt === "undefined" || typeof gantt.ext === "undefined" || typeof gantt.ext.zoom === "undefined") {
                document.getElementById("gantt_here").innerHTML = 
                    '<div style="padding: 20px; text-align: center; font-size: 16px; color: red;">' +
                    'Error: The dhtmlxGantt Pro library failed to load. Please check the file paths.' +
                    '</div>';
                loadingOverlay.style.display = 'none';
                return;
            }

            // --- Gantt Configuration ---
            gantt.config.date_format = "%Y-%m-%d";
            gantt.config.row_height = 36;
            gantt.config.scale_height = 50;
            gantt.config.details_on_dblclick = false;
            gantt.config.drag_links = true;
            gantt.config.grid_resize = true;
            
            // Define columns with Finish date
            gantt.config.columns = [
                { 
                    name: "text", 
                    label: "WBS / TASK", 
                    tree: true, 
                    width: 320, 
                    resize: true, 
                    editor: {type: "text", map_to: "text"},
                    template: function(task) {
                        return task.text;
                    }
                },
                { 
                    name: "start_date", 
                    label: "START", 
                    align: "center", 
                    width: 100, 
                    resize: true, 
                    editor: {type: "date", map_to: "start_date", min: new Date(2010, 0, 1), max: new Date(2030, 0, 1)},
                    template: function(task) {
                        if (task.type === "project") return "";
                        return gantt.date.date_to_str("%d %M")(task.start_date);
                    }
                },
                { 
                    name: "end_date", 
                    label: "FINISH", 
                    align: "center", 
                    width: 100, 
                    resize: true,
                    editor: {
                        type: "date", 
                        map_to: "end_date", 
                        min: new Date(2010, 0, 1), 
                        max: new Date(2030, 0, 1)
                    },
                    template: function(task) {
                        if (task.type === "project") return "";
                        if (task.type === "milestone") {
                            return gantt.date.date_to_str("%d %M")(task.start_date);
                        }
                        const finish = gantt.calculateEndDate(task.start_date, task.duration);
                        return gantt.date.date_to_str("%d %M")(finish);
                    }
                },
                { 
                    name: "duration", 
                    label: "DURATION", 
                    align: "center", 
                    width: 100, 
                    resize: true, 
                    editor: {type: "number", map_to: "duration", min:0, max: 1000},
                    template: function(task) {
                        if (task.type === "project") return "";
                        return task.duration + (task.duration == 1 ? " day" : " days");
                    }
                },
                { 
                    name: "progress", 
                    label: "PROGRESS", 
                    align: "center", 
                    width: 100, 
                    resize: true,
                    template: function(task) {
                        if (task.type === 'milestone') return "—";
                        if (task.type === 'project') return "";
                        return Math.round((task.progress || 0) * 100) + "%";
                    } 
                }
            ];
            
            // Apply custom styling classes
            gantt.templates.task_class = (start, end, task) => {
                let classes = [];
                if (task.type === "project") classes.push("gantt_project");
                if (task.type === "milestone") classes.push("gantt_milestone");
                if (task.hide_bar) classes.push("gantt_invisible_bar");
                return classes.join(" ");
            };
            
            // Prevent linking involving WBS elements
            gantt.attachEvent("onBeforeLinkAdd", (id, link) => {
                const source = gantt.getTask(link.source);
                const target = gantt.getTask(link.target);
                if(source.type === "project" || target.type === "project"){
                    return false;
                }
                return true;
            });
            
            // --- Zoom Configuration ---
            var zoomConfig = {
                levels: [
                    { 
                        name: "day", 
                        scale_height: 30, 
                        min_column_width: 80, 
                        scales: [
                            { unit: "day", step: 1, format: "%d %M" }
                        ] 
                    },
                    { 
                        name: "week", 
                        scale_height: 50, 
                        min_column_width: 50, 
                        scales: [ 
                            { unit: "week", step: 1, format: function (date) { 
                                return "Week #" + gantt.date.date_to_str("%W")(date); 
                            } }, 
                            { unit: "day", step: 1, format: "%j %D" } 
                        ] 
                    },
                    { 
                        name: "month", 
                        scale_height: 50, 
                        min_column_width: 120, 
                        scales: [ 
                            { unit: "month", step: 1, format: "%F, %Y" }, 
                            { unit: "week", step: 1, format: "Week #%W" } 
                        ] 
                    },
                    { 
                        name: "quarter", 
                        scale_height: 50, 
                        min_column_width: 150,
                        scales: [
                            { 
                                unit: "quarter", 
                                step: 1, 
                                format: function(date) {
                                    const quarter = Math.floor((date.getMonth() + 3) / 3);
                                    return `Q${quarter} ${date.getFullYear()}`;
                                }
                            },
                            { 
                                unit: "month", 
                                step: 1, 
                                format: "%M"
                            }
                        ]
                    },
                    { 
                        name: "year", 
                        scale_height: 50, 
                        min_column_width: 30, 
                        scales: [
                            { unit: "year", step: 1, format: "%Y" }
                        ] 
                    }
                ]
            };
            
            gantt.ext.zoom.init(zoomConfig);
            gantt.ext.zoom.setLevel("week");

            // Initialize Gantt
            gantt.init("gantt_here");
            
            // --- Timeline Scale Selection ---
            document.getElementById("timeline-scale").addEventListener("change", function() {
                if(this.value === "fit") {
                    gantt.ext.zoom.fit();
                } else {
                    gantt.ext.zoom.setLevel(this.value);
                }
            });
            
            // --- Optimized Data Processing Functions ---
            function processGanttData(rawData) {
                const tasks = new Map();
                const wbsSet = new Set();

                // Create all WBS items
                rawData.forEach(item => {
                    if (item.wbs_id && !wbsSet.has(item.wbs_id)) {
                        tasks.set(item.wbs_id, {
                            id: item.wbs_id,
                            text: item.wbs_name || `WBS-${item.wbs_id}`,
                            parent: item.wbs_parent_id || null,
                            type: "project",
                            open: true,
                            rollup: false,
                            hide_bar: false
                        });
                        wbsSet.add(item.wbs_id);
                    }
                });
                
                // Create tasks and milestones
                rawData.forEach(item => {
                    if (item.activity_id) {
                        let startDate;
                        try {
                            if (item.start_date) {
                                startDate = new Date(item.start_date);
                                if (isNaN(startDate.getTime())) throw new Error("Invalid date");
                            } else { 
                                throw new Error("Missing start date"); 
                            }
                        } catch (e) {
                            startDate = new Date();
                        }
                        
                        const duration = item.duration || (item.type === 'milestone' ? 0 : 1);
                        
                        const taskData = {
                            id: item.activity_id, 
                            text: item.activity_name || `Task-${item.activity_id}`,
                            start_date: startDate, 
                            duration: duration, 
                            progress: item.progress || 0,
                            parent: item.wbs_id, 
                            type: item.type || "task",
                            rollup: item.rollup || false,
                            hide_bar: item.hide_bar || false
                        };
                        tasks.set(item.activity_id, taskData);
                    }
                });
                
                // Create placeholder WBS for any missing parents
                rawData.forEach(item => {
                    if (item.wbs_parent_id && !tasks.has(item.wbs_parent_id)) {
                        tasks.set(item.wbs_parent_id, {
                           id: item.wbs_parent_id, 
                           text: `WBS-${item.wbs_parent_id}`,
                           parent: null, 
                           type: "project", 
                           open: true,
                           rollup: false,
                           hide_bar: false
                        });
                    }
                });

                return { data: Array.from(tasks.values()), links: [] };
            }
            
            function renderGantt(ganttTasks) {
                gantt.clearAll();
                gantt.parse(ganttTasks);
                // Auto-fit timeline after render
                setTimeout(() => {
                    if(document.getElementById("timeline-scale").value === "fit") {
                        gantt.ext.zoom.fit();
                    }
                }, 100);
            }
            
            // --- Functions to Expand/Collapse All WBS Tasks ---
            function expandAll() {
                gantt.startBatch();
                gantt.eachTask(function (task) {
                    if (task.type === "project") {
                        gantt.open(task.id);
                    }
                });
                gantt.endBatch();
            }

            function collapseAll() {
                gantt.startBatch();
                gantt.eachTask(function (task) {
                    if (task.type === "project") {
                        gantt.close(task.id);
                    }
                });
                gantt.endBatch();
            }
            
            // --- Data Loading via postMessage ---
            window.addEventListener("message", (event) => {
                // IMPORTANT: In production, validate the event.origin
                // if (event.origin !== "https://your-bubble-app.com") return;
                
                try {
                    const data = JSON.parse(event.data);
                    console.log("Received data from Bubble:", data);
                    
                    // Process and render the data
                    const ganttTasks = processGanttData(data.activities);
                    renderGantt(ganttTasks);
                    
                    // Auto-expand after data load
                    setTimeout(expandAll, 100);
                    
                    // Hide loading overlay
                    loadingOverlay.style.display = 'none';
                    
                    // Show success message
                    showMessage('Data Loaded', `Successfully loaded ${data.activities.length} activities`);
                    
                } catch (e) {
                    console.error("Failed to parse message data", e);
                    showMessage('Data Error', 'Invalid data format from Bubble');
                }
            });
            
            // --- Event Handlers ---
            document.getElementById("expand-all-btn").addEventListener("click", expandAll);
            document.getElementById("collapse-all-btn").addEventListener("click", collapseAll);
            document.getElementById("refresh-data-btn").addEventListener("click", () => {
                // Send a message back to Bubble to request fresh data
                window.parent.postMessage(JSON.stringify({ type: "refresh" }), "*");
                showMessage('Refreshing Data', 'Requesting fresh data from Bubble...');
                loadingOverlay.style.display = 'flex';
            });

            // Ensure Gantt chart resizes with container
            window.addEventListener("resize", function() {
                if (gantt.$container) {
                    gantt.render();
                }
            });
            
            // Notify Bubble that we're ready to receive data
            window.parent.postMessage(JSON.stringify({ type: "ready" }), "*");
        });
    </script>
</body>
</html>
