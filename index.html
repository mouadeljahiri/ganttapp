<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Construction Project Gantt Chart</title>
    
    <link rel="stylesheet" href="./codebase/dhtmlxgantt.css">
    <script src="./codebase/dhtmlxgantt.js"></script>
    <script src="./codebase/ext/dhtmlxgantt_zoom.js"></script>
    
    <style>
        /* ... (keep all existing CSS styles) ... */
    </style>
</head>
<body>
    <div class="container">
        <div class="toolbar">
            <button id="expand-all-btn">Expand All</button>
            <button id="collapse-all-btn">Collapse All</button>
            <select id="timeline-scale">
                <option value="day">Day View</option>
                <option value="week" selected>Week View</option>
                <option value="month">Month View</option>
                <option value="quarter">Quarter View</option>
                <option value="year">Year View</option>
                <option value="fit">Fit Content</option>
            </select>
            <button id="refresh-data-btn">Refresh Data</button>
        </div>

        <div class="chart-container">
            <div id="gantt_here"></div>
        </div>
    </div>
    
    <script>
        document.addEventListener("DOMContentLoaded", function() {
            // Check if the gantt object and its zoom extension exist
            if (typeof gantt === "undefined" || typeof gantt.ext === "undefined" || typeof gantt.ext.zoom === "undefined") {
                document.getElementById("gantt_here").innerHTML = 
                    '<div style="padding: 20px; text-align: center; font-size: 16px; color: red;">' +
                    'Error: The dhtmlxGantt library or a required extension (e.g., zoom) failed to load. Please check that the script files are correctly linked in the &lt;head&gt; section.' +
                    '</div>';
                return;
            }

            // --- Rollup Configuration ---
            gantt.config.scale_height = 50;
            gantt.locale.labels.section_rollup = "Rollup";
            gantt.locale.labels.section_hide_bar = "Hide bar";
            
            gantt.config.lightbox.sections = [
                {name: "description", height: 70, map_to: "text", type: "textarea", focus: true},
                {name: "rollup", type: "checkbox", map_to: "rollup"},
                {name: "hide_bar", type: "checkbox", map_to: "hide_bar"},
                {name: "type", type: "typeselect", map_to: "type"},
                {name: "time", type: "duration", map_to: "auto"}
            ];
            
            gantt.config.lightbox.milestone_sections = [
                {name: "description", height: 70, map_to: "text", type: "textarea", focus: true},
                {name: "rollup", type: "checkbox", map_to: "rollup"},
                {name: "hide_bar", type: "checkbox", map_to: "hide_bar"},
                {name: "type", type: "typeselect", map_to: "type"},
                {name: "time", type: "duration", map_to: "auto"}
            ];
            
            gantt.config.lightbox.project_sections = [
                {name: "description", height: 70, map_to: "text", type: "textarea", focus: true},
                {name: "hide_bar", type: "checkbox", map_to: "hide_bar"},
                {name: "type", type: "typeselect", map_to: "type"},
                {name: "time", type: "duration", map_to: "auto"}
            ];
            
            // Show milestone text on summary bars
            gantt.templates.rightside_text = function (start, end, task) {
                if (task.type == "milestone" && task.rollup) {
                    return "<div class='rollup_text'>" + task.text + "</div>";
                }
                return "";
            };
            
            // --- Gantt Configuration ---
            gantt.config.date_format = "%Y-%m-%d";
            gantt.config.row_height = 32;
            gantt.config.scale_height = 45;
            gantt.config.details_on_dblclick = false;
            gantt.config.drag_links = true;
            gantt.config.grid_resize = true;
            
            // Define columns with Finish date
            gantt.config.columns = [
                { 
                    name: "text", 
                    label: "WBS / TASK", 
                    tree: true, 
                    width: 300, 
                    resize: true, 
                    editor: {type: "text", map_to: "text"},
                    template: function(task) {
                        return task.text;
                    }
                },
                { 
                    name: "start_date", 
                    label: "START", 
                    align: "center", 
                    width: 100, 
                    resize: true, 
                    editor: {type: "date", map_to: "start_date", min: new Date(2010, 0, 1), max: new Date(2030, 0, 1)},
                    template: function(task) {
                        if (task.type === "project") return "";
                        return gantt.date.date_to_str("%d %M")(task.start_date);
                    }
                },
                { 
                    name: "end_date", 
                    label: "FINISH", 
                    align: "center", 
                    width: 100, 
                    resize: true,
                    editor: {
                        type: "date", 
                        map_to: "end_date", 
                        min: new Date(2010, 0, 1), 
                        max: new Date(2030, 0, 1)
                    },
                    template: function(task) {
                        if (task.type === "project") return "";
                        if (task.type === "milestone") {
                            return gantt.date.date_to_str("%d %M")(task.start_date);
                        }
                        const finish = gantt.calculateEndDate(task.start_date, task.duration);
                        return gantt.date.date_to_str("%d %M")(finish);
                    }
                },
                { 
                    name: "duration", 
                    label: "DURATION", 
                    align: "center", 
                    width: 90, 
                    resize: true, 
                    editor: {type: "number", map_to: "duration", min:0, max: 1000},
                    template: function(task) {
                        if (task.type === "project") return "";
                        return task.duration + (task.duration == 1 ? " day" : " days");
                    }
                },
                { 
                    name: "progress", 
                    label: "PROGRESS", 
                    align: "center", 
                    width: 90, 
                    resize: true,
                    template: function(task) {
                        if (task.type === 'milestone') return "â€”";
                        if (task.type === 'project') return "";
                        return Math.round((task.progress || 0) * 100) + "%";
                    } 
                }
            ];
            
            // Apply custom styling classes
            gantt.templates.task_class = (start, end, task) => {
                let classes = [];
                if (task.type === "project") classes.push("gantt_project");
                if (task.type === "milestone") classes.push("gantt_milestone");
                if (task.hide_bar) classes.push("gantt_invisible_bar");
                return classes.join(" ");
            };
            
            // Prevent linking involving WBS elements
            gantt.attachEvent("onBeforeLinkAdd", (id, link) => {
                const source = gantt.getTask(link.source);
                const target = gantt.getTask(link.target);
                if(source.type === "project" || target.type === "project"){
                    return false;
                }
                return true;
            });
            
            // --- Zoom Configuration ---
            var zoomConfig = {
                levels: [
                    { 
                        name: "day", 
                        scale_height: 27, 
                        min_column_width: 80, 
                        scales: [
                            { unit: "day", step: 1, format: "%d %M" }
                        ] 
                    },
                    { 
                        name: "week", 
                        scale_height: 50, 
                        min_column_width: 50, 
                        scales: [ 
                            { unit: "week", step: 1, format: function (date) { 
                                return "Week #" + gantt.date.date_to_str("%W")(date); 
                            } }, 
                            { unit: "day", step: 1, format: "%j %D" } 
                        ] 
                    },
                    { 
                        name: "month", 
                        scale_height: 50, 
                        min_column_width: 120, 
                        scales: [ 
                            { unit: "month", step: 1, format: "%F, %Y" }, 
                            { unit: "week", step: 1, format: "Week #%W" } 
                        ] 
                    },
                    { 
                        name: "quarter", 
                        scale_height: 50, 
                        min_column_width: 150,
                        scales: [
                            { 
                                unit: "quarter", 
                                step: 1, 
                                format: function(date) {
                                    const quarter = Math.floor((date.getMonth() + 3) / 3);
                                    return `Q${quarter} ${date.getFullYear()}`;
                                }
                            },
                            { 
                                unit: "month", 
                                step: 1, 
                                format: "%M"
                            }
                        ]
                    },
                    { 
                        name: "year", 
                        scale_height: 50, 
                        min_column_width: 30, 
                        scales: [
                            { unit: "year", step: 1, format: "%Y" }
                        ] 
                    }
                ]
            };
            
            gantt.ext.zoom.init(zoomConfig);
            gantt.ext.zoom.setLevel("week");

            // Initialize Gantt
            gantt.init("gantt_here");
            
            // --- Timeline Scale Selection ---
            document.getElementById("timeline-scale").addEventListener("change", function() {
                if(this.value === "fit") {
                    gantt.ext.zoom.fit();
                } else {
                    gantt.ext.zoom.setLevel(this.value);
                }
            });
            
            // --- Optimized Data Processing Functions ---
            function processGanttData(rawData) {
                const tasks = new Map();
                const wbsSet = new Set();

                // Create all WBS items
                rawData.forEach(item => {
                    if (item.wbs_id && !wbsSet.has(item.wbs_id)) {
                        tasks.set(item.wbs_id, {
                            id: item.wbs_id,
                            text: item.wbs_name || `WBS-${item.wbs_id}`,
                            parent: item.wbs_parent_id || null,
                            type: "project",
                            open: true,
                            rollup: false,
                            hide_bar: false
                        });
                        wbsSet.add(item.wbs_id);
                    }
                });
                
                // Create tasks and milestones
                rawData.forEach(item => {
                    if (item.activity_id) {
                        let startDate;
                        try {
                            if (item.start_date) {
                                startDate = new Date(item.start_date);
                                if (isNaN(startDate.getTime())) throw new Error("Invalid date");
                            } else { 
                                throw new Error("Missing start date"); 
                            }
                        } catch (e) {
                            startDate = new Date();
                        }
                        
                        const duration = item.duration || (item.type === 'milestone' ? 0 : 1);
                        
                        const taskData = {
                            id: item.activity_id, 
                            text: item.activity_name || `Task-${item.activity_id}`,
                            start_date: startDate, 
                            duration: duration, 
                            progress: item.progress || 0,
                            parent: item.wbs_id, 
                            type: item.type || "task",
                            rollup: item.rollup || false,
                            hide_bar: item.hide_bar || false
                        };
                        tasks.set(item.activity_id, taskData);
                    }
                });
                
                // Create placeholder WBS for any missing parents
                rawData.forEach(item => {
                    if (item.wbs_parent_id && !tasks.has(item.wbs_parent_id)) {
                        tasks.set(item.wbs_parent_id, {
                           id: item.wbs_parent_id, 
                           text: `WBS-${item.wbs_parent_id}`,
                           parent: null, 
                           type: "project", 
                           open: true,
                           rollup: false,
                           hide_bar: false
                        });
                    }
                });

                return { data: Array.from(tasks.values()), links: [] };
            }
            
            function renderGantt(ganttTasks) {
                gantt.clearAll();
                gantt.parse(ganttTasks);
                // Auto-fit timeline after render
                setTimeout(() => {
                    if(document.getElementById("timeline-scale").value === "fit") {
                        gantt.ext.zoom.fit();
                    }
                }, 100);
            }
            
            // --- Functions to Expand/Collapse All WBS Tasks ---
            function expandAll() {
                gantt.startBatch();
                gantt.eachTask(function (task) {
                    if (task.type === "project") {
                        gantt.open(task.id);
                    }
                });
                gantt.endBatch();
            }

            function collapseAll() {
                gantt.startBatch();
                gantt.eachTask(function (task) {
                    if (task.type === "project") {
                        gantt.close(task.id);
                    }
                });
                gantt.endBatch();
            }
            
            // --- Bubble Integration via postMessage ---
            const allowedOrigins = [
                "https://bubble.io",
                "http://localhost:8000"  // For local development
            ];
            
            // Notify parent we're ready
            window.parent.postMessage(JSON.stringify({
                type: 'ready'
            }), '*');
            
            // Handle incoming messages from Bubble
            window.addEventListener('message', function(event) {
                // Validate origin
                if (!allowedOrigins.includes(event.origin)) {
                    console.warn('Message from unauthorized origin:', event.origin);
                    return;
                }
                
                let data;
                try {
                    data = JSON.parse(event.data);
                } catch (e) {
                    console.error('Error parsing message:', event.data);
                    return;
                }
                
                // Handle different message types
                if (Array.isArray(data)) {
                    // Direct array of tasks
                    const ganttTasks = processGanttData(data);
                    renderGantt(ganttTasks);
                    setTimeout(expandAll, 100);
                } 
                else if (data.activities && Array.isArray(data.activities)) {
                    // Structured response with activities array
                    const ganttTasks = processGanttData(data.activities);
                    renderGantt(ganttTasks);
                    setTimeout(expandAll, 100);
                }
                else if (data.type === 'error') {
                    console.error('Error from Bubble:', data.message);
                }
                else if (data.type === 'no-project') {
                    console.warn('No project ID specified');
                }
            });
            
            // --- Event Handlers ---
            document.getElementById("expand-all-btn").addEventListener("click", expandAll);
            document.getElementById("collapse-all-btn").addEventListener("click", collapseAll);
            document.getElementById("refresh-data-btn").addEventListener("click", function() {
                window.parent.postMessage(JSON.stringify({
                    type: 'refresh'
                }), '*');
            });

            // Ensure Gantt chart resizes with container
            window.addEventListener("resize", function() {
                if (gantt.$container) {
                    gantt.render();
                }
            });
        });
    </script>
</body>
</html>
