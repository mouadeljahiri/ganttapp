<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Construction Project Gantt Chart</title>
    
    <link rel="stylesheet" href="./codebase/dhtmlxgantt.css">
    <script src="./codebase/dhtmlxgantt.js"></script>
    <script src="./codebase/ext/dhtmlxgantt_zoom.js"></script>
    
    <style>
        /* ... (existing styles remain the same) ... */
        
        /* Add filter controls styling */
        .filter-controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            flex-grow: 1;
            margin-left: auto;
        }
        
        .filter-controls select, 
        .filter-controls input {
            padding: 8px 12px;
            border-radius: 6px;
            border: 1px solid #ddd;
            background: white;
            font-size: 14px;
        }
        
        .filter-controls input {
            min-width: 200px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="toolbar">
            <button id="expand-all-btn">Expand All</button>
            <button id="collapse-all-btn">Collapse All</button>
            <select id="timeline-scale">
                <option value="day">Day View</option>
                <option value="week" selected>Week View</option>
                <option value="month">Month View</option>
                <option value="quarter">Quarter View</option>
                <option value="year">Year View</option>
                <option value="fit">Fit Content</option>
            </select>
            <button id="refresh-data-btn">Refresh Data</button>
            
            <div class="filter-controls">
                <select id="project-filter">
                    <option value="">All Projects</option>
                </select>
                <select id="wbs-filter">
                    <option value="">All WBS</option>
                </select>
                <input type="text" id="task-filter" placeholder="Filter tasks...">
            </div>
        </div>

        <div class="chart-container">
            <div id="gantt_here"></div>
        </div>
    </div>
    
    <script>
        // Function to get URL parameter
        function getUrlParameter(name) {
            name = name.replace(/[\[\]]/g, '\\$&');
            const regex = new RegExp('[?&]' + name + '(=([^&#]*)|&|#|$)');
            const results = regex.exec(window.location.href);
            if (!results) return null;
            if (!results[2]) return '';
            return decodeURIComponent(results[2].replace(/\+/g, ' '));
        }

        document.addEventListener("DOMContentLoaded", function() {
            // Get parameters from URL
            const apiUrl = getUrlParameter('api_url') || "https://cpmchart.onrender.com/gantt-data";
            const projectId = getUrlParameter('project_id');
            const statusFilter = getUrlParameter('status');
            
            // Check if the gantt object and its zoom extension exist. If not, the library failed to load.
            if (typeof gantt === "undefined" || typeof gantt.ext === "undefined" || typeof gantt.ext.zoom === "undefined") {
                document.getElementById("gantt_here").innerHTML = 
                    '<div style="padding: 20px; text-align: center; font-size: 16px; color: red;">' +
                    'Error: The dhtmlxGantt library or a required extension (e.g., zoom) failed to load. Please check that the script files are correctly linked in the &lt;head&gt; section.' +
                    '</div>';
                return; // Stop executing the rest of the script
            }

            // --- Rollup Configuration ---
            gantt.config.scale_height = 50;
            gantt.locale.labels.section_rollup = "Rollup";
            gantt.locale.labels.section_hide_bar = "Hide bar";
            
            gantt.config.lightbox.sections = [
                {name: "description", height: 70, map_to: "text", type: "textarea", focus: true},
                {name: "rollup", type: "checkbox", map_to: "rollup"},
                {name: "hide_bar", type: "checkbox", map_to: "hide_bar"},
                {name: "type", type: "typeselect", map_to: "type"},
                {name: "time", type: "duration", map_to: "auto"}
            ];
            
            gantt.config.lightbox.milestone_sections = [
                {name: "description", height: 70, map_to: "text", type: "textarea", focus: true},
                {name: "rollup", type: "checkbox", map_to: "rollup"},
                {name: "hide_bar", type: "checkbox", map_to: "hide_bar"},
                {name: "type", type: "typeselect", map_to: "type"},
                {name: "time", type: "duration", map_to: "auto"}
            ];
            
            gantt.config.lightbox.project_sections = [
                {name: "description", height: 70, map_to: "text", type: "textarea", focus: true},
                {name: "hide_bar", type: "checkbox", map_to: "hide_bar"},
                {name: "type", type: "typeselect", map_to: "type"},
                {name: "time", type: "duration", map_to: "auto"}
            ];
            
            // Show milestone text on summary bars
            gantt.templates.rightside_text = function (start, end, task) {
                if (task.type == "milestone" && task.rollup) {
                    return "<div class='rollup_text'>" + task.text + "</div>";
                }
                return "";
            };
            
            // --- Gantt Configuration ---
            gantt.config.date_format = "%Y-%m-%d";
            gantt.config.row_height = 32;
            gantt.config.scale_height = 45;
            gantt.config.details_on_dblclick = false;
            gantt.config.drag_links = true;
            gantt.config.grid_resize = true;
            
            // Define columns with Finish date
            gantt.config.columns = [
                { 
                    name: "text", 
                    label: "WBS / TASK", 
                    tree: true, 
                    width: 300, 
                    resize: true, 
                    editor: {type: "text", map_to: "text"},
                    template: function(task) {
                        return task.text;
                    }
                },
                { 
                    name: "start_date", 
                    label: "START", 
                    align: "center", 
                    width: 100, 
                    resize: true, 
                    editor: {type: "date", map_to: "start_date", min: new Date(2010, 0, 1), max: new Date(2030, 0, 1)},
                    template: function(task) {
                        if (task.type === "project") return "";
                        return gantt.date.date_to_str("%d %M")(task.start_date);
                    }
                },
                { 
                    name: "end_date", 
                    label: "FINISH", 
                    align: "center", 
                    width: 100, 
                    resize: true,
                    editor: {
                        type: "date", 
                        map_to: "end_date", 
                        min: new Date(2010, 0, 1), 
                        max: new Date(2030, 0, 1)
                    },
                    template: function(task) {
                        if (task.type === "project") return "";
                        if (task.type === "milestone") {
                            return gantt.date.date_to_str("%d %M")(task.start_date);
                        }
                        const finish = gantt.calculateEndDate(task.start_date, task.duration);
                        return gantt.date.date_to_str("%d %M")(finish);
                    }
                },
                { 
                    name: "duration", 
                    label: "DURATION", 
                    align: "center", 
                    width: 90, 
                    resize: true, 
                    editor: {type: "number", map_to: "duration", min:0, max: 1000},
                    template: function(task) {
                        if (task.type === "project") return "";
                        return task.duration + (task.duration == 1 ? " day" : " days");
                    }
                },
                { 
                    name: "progress", 
                    label: "PROGRESS", 
                    align: "center", 
                    width: 90, 
                    resize: true,
                    template: function(task) {
                        if (task.type === 'milestone') return "â€”";
                        if (task.type === 'project') return "";
                        return Math.round((task.progress || 0) * 100) + "%";
                    } 
                }
            ];
            
            // Apply custom styling classes
            gantt.templates.task_class = (start, end, task) => {
                let classes = [];
                if (task.type === "project") classes.push("gantt_project");
                if (task.type === "milestone") classes.push("gantt_milestone");
                if (task.hide_bar) classes.push("gantt_invisible_bar");
                return classes.join(" ");
            };
            
            // Prevent linking involving WBS elements
            gantt.attachEvent("onBeforeLinkAdd", (id, link) => {
                const source = gantt.getTask(link.source);
                const target = gantt.getTask(link.target);
                if(source.type === "project" || target.type === "project"){
                    return false;
                }
                return true;
            });
            
            // --- Zoom Configuration ---
            var zoomConfig = {
                levels: [
                    { 
                        name: "day", 
                        scale_height: 27, 
                        min_column_width: 80, 
                        scales: [
                            { unit: "day", step: 1, format: "%d %M" }
                        ] 
                    },
                    { 
                        name: "week", 
                        scale_height: 50, 
                        min_column_width: 50, 
                        scales: [ 
                            { unit: "week", step: 1, format: function (date) { 
                                return "Week #" + gantt.date.date_to_str("%W")(date); 
                            } }, 
                            { unit: "day", step: 1, format: "%j %D" } 
                        ] 
                    },
                    { 
                        name: "month", 
                        scale_height: 50, 
                        min_column_width: 120, 
                        scales: [ 
                            { unit: "month", step: 1, format: "%F, %Y" }, 
                            { unit: "week", step: 1, format: "Week #%W" } 
                        ] 
                    },
                    { 
                        name: "quarter", 
                        scale_height: 50, 
                        min_column_width: 150,
                        scales: [
                            { 
                                unit: "quarter", 
                                step: 1, 
                                format: function(date) {
                                    const quarter = Math.floor((date.getMonth() + 3) / 3);
                                    return `Q${quarter} ${date.getFullYear()}`;
                                }
                            },
                            { 
                                unit: "month", 
                                step: 1, 
                                format: "%M"
                            }
                        ]
                    },
                    { 
                        name: "year", 
                        scale_height: 50, 
                        min_column_width: 30, 
                        scales: [
                            { unit: "year", step: 1, format: "%Y" }
                        ] 
                    }
                ]
            };
            
            gantt.ext.zoom.init(zoomConfig);
            gantt.ext.zoom.setLevel("week");

            // Initialize Gantt
            gantt.init("gantt_here");
            
            // --- Timeline Scale Selection ---
            document.getElementById("timeline-scale").addEventListener("change", function() {
                if(this.value === "fit") {
                    gantt.ext.zoom.fit();
                } else {
                    gantt.ext.zoom.setLevel(this.value);
                }
            });
            
            // --- Optimized Data Processing Functions ---
            function processGanttData(rawData) {
                const tasks = new Map();
                const wbsSet = new Set();

                // Create all WBS items
                rawData.forEach(item => {
                    if (item.wbs_id && !wbsSet.has(item.wbs_id)) {
                        tasks.set(item.wbs_id, {
                            id: item.wbs_id,
                            text: item.wbs_name || `WBS-${item.wbs_id}`,
                            parent: item.wbs_parent_id || null,
                            type: "project",
                            open: true,
                            rollup: false,
                            hide_bar: false
                        });
                        wbsSet.add(item.wbs_id);
                    }
                });
                
                // Create tasks and milestones
                rawData.forEach(item => {
                    if (item.activity_id) {
                        let startDate;
                        try {
                            if (item.start_date) {
                                startDate = new Date(item.start_date);
                                if (isNaN(startDate.getTime())) throw new Error("Invalid date");
                            } else { 
                                throw new Error("Missing start date"); 
                            }
                        } catch (e) {
                            startDate = new Date();
                        }
                        
                        const duration = item.duration || (item.type === 'milestone' ? 0 : 1);
                        
                        const taskData = {
                            id: item.activity_id, 
                            text: item.activity_name || `Task-${item.activity_id}`,
                            start_date: startDate, 
                            duration: duration, 
                            progress: item.progress || 0,
                            parent: item.wbs_id, 
                            type: item.type || "task",
                            rollup: item.rollup || false,
                            hide_bar: item.hide_bar || false
                        };
                        tasks.set(item.activity_id, taskData);
                    }
                });
                
                // Create placeholder WBS for any missing parents
                rawData.forEach(item => {
                    if (item.wbs_parent_id && !tasks.has(item.wbs_parent_id)) {
                        tasks.set(item.wbs_parent_id, {
                           id: item.wbs_parent_id, 
                           text: `WBS-${item.wbs_parent_id}`,
                           parent: null, 
                           type: "project", 
                           open: true,
                           rollup: false,
                           hide_bar: false
                        });
                    }
                });

                return { data: Array.from(tasks.values()), links: [] };
            }
            
            function renderGantt(ganttTasks) {
                gantt.clearAll();
                gantt.parse(ganttTasks);
                // Auto-fit timeline after render
                setTimeout(() => {
                    if(document.getElementById("timeline-scale").value === "fit") {
                        gantt.ext.zoom.fit();
                    }
                }, 100);
            }
            
            // --- Functions to Expand/Collapse All WBS Tasks ---
            function expandAll() {
                gantt.startBatch();
                gantt.eachTask(function (task) {
                    if (task.type === "project") {
                        gantt.open(task.id);
                    }
                });
                gantt.endBatch();
            }

            function collapseAll() {
                gantt.startBatch();
                gantt.eachTask(function (task) {
                    if (task.type === "project") {
                        gantt.close(task.id);
                    }
                });
                gantt.endBatch();
            }
            
            // --- Filtering System ---
            let allTasks = [];
            let projects = [];
            let wbsLevels = [];

            function setupFilters() {
                // Extract unique projects and WBS levels
                projects = [...new Set(allTasks.filter(t => t.type === "project" && !t.parent).map(p => p.text))];
                wbsLevels = [...new Set(allTasks.filter(t => t.type === "project" && t.parent).map(w => w.text))];

                // Populate project filter
                const projectFilter = document.getElementById("project-filter");
                projects.forEach(project => {
                    const option = document.createElement("option");
                    option.value = project;
                    option.textContent = project;
                    projectFilter.appendChild(option);
                });

                // Project filter change handler
                projectFilter.addEventListener("change", function() {
                    const wbsFilter = document.getElementById("wbs-filter");
                    wbsFilter.innerHTML = '<option value="">All WBS</option>';
                    
                    if (this.value) {
                        // Find the selected project
                        const projectTask = allTasks.find(t => t.text === this.value && t.type === "project" && !t.parent);
                        
                        if (projectTask) {
                            // Filter WBS options based on selected project
                            const projectWBS = allTasks.filter(task => 
                                task.parent === projectTask.id && 
                                task.type === "project"
                            );
                            
                            projectWBS.forEach(wbs => {
                                const option = document.createElement("option");
                                option.value = wbs.text;
                                option.textContent = wbs.text;
                                wbsFilter.appendChild(option);
                            });
                        }
                    }
                    
                    applyFilters();
                });

                // WBS filter change handler
                document.getElementById("wbs-filter").addEventListener("change", applyFilters);
                
                // Task filter input handler
                document.getElementById("task-filter").addEventListener("input", applyFilters);
                
                // Apply initial filter if project_id is in URL
                if (projectId) {
                    const project = allTasks.find(t => 
                        t.id === projectId && 
                        t.type === "project" &&
                        !t.parent
                    );
                    
                    if (project) {
                        projectFilter.value = project.text;
                        const event = new Event('change');
                        projectFilter.dispatchEvent(event);
                    }
                }
            }

            function applyFilters() {
                const projectFilter = document.getElementById("project-filter").value;
                const wbsFilter = document.getElementById("wbs-filter").value;
                const taskFilter = document.getElementById("task-filter").value.toLowerCase();

                const filteredTasks = allTasks.filter(task => {
                    // Skip hidden bar tasks
                    if (task.hide_bar) return true;
                    
                    // Get parent names for hierarchy filtering
                    let parentNames = [];
                    let current = task;
                    while (current.parent) {
                        current = gantt.getTask(current.parent);
                        if (current) parentNames.push(current.text);
                    }
                    
                    // Apply filters
                    const matchesProject = !projectFilter || 
                                        task.text === projectFilter || 
                                        parentNames.includes(projectFilter);
                    
                    const matchesWBS = !wbsFilter || 
                                    task.text === wbsFilter || 
                                    parentNames.includes(wbsFilter);
                    
                    const matchesTask = !taskFilter || 
                                     task.text.toLowerCase().includes(taskFilter);

                    return matchesProject && matchesWBS && matchesTask;
                });

                // Create a set of IDs to keep (matched tasks + their parents)
                const keepIds = new Set();
                filteredTasks.forEach(task => {
                    // Add the task
                    keepIds.add(task.id);
                    
                    // Add all parents
                    let parentId = task.parent;
                    while (parentId) {
                        keepIds.add(parentId);
                        const parentTask = gantt.getTask(parentId);
                        parentId = parentTask ? parentTask.parent : null;
                    }
                });

                // Apply visibility
                gantt.eachTask(task => {
                    task.$hidden = !keepIds.has(task.id);
                    if (task.$hidden && task.type === "project") {
                        gantt.close(task.id);
                    } else if (!task.$hidden && task.type === "project") {
                        gantt.open(task.id);
                    }
                });

                gantt.refreshData();
            }
            
            // --- Efficient Data Loading Function ---
            function loadGanttData() {
                // Build API URL with filters
                let finalApiUrl = apiUrl;
                if (projectId) {
                    finalApiUrl += (finalApiUrl.includes('?') ? '&' : '?') + 'project_id=' + projectId;
                }
                if (statusFilter) {
                    finalApiUrl += (finalApiUrl.includes('?') ? '&' : '?') + 'status=' + statusFilter;
                }

                fetch(finalApiUrl)
                    .then(response => {
                        if (!response.ok) throw new Error("Network response was not ok: " + response.status);
                        return response.json();
                    })
                    .then(apiResponse => {
                        let rawData;
                        if (Array.isArray(apiResponse)) {
                            rawData = apiResponse;
                        } else if (Array.isArray(apiResponse.data)) {
                            rawData = apiResponse.data;
                        } else {
                            throw new Error("Invalid API response format.");
                        }
                        
                        if (rawData.length === 0) {
                            throw new Error("API returned an empty data array.");
                        }
                        
                        const ganttTasks = processGanttData(rawData);
                        allTasks = ganttTasks.data;
                        renderGantt(ganttTasks);
                        
                        // Auto-expand after data load
                        setTimeout(() => {
                            expandAll();
                            setupFilters();
                        }, 100);
                    })
                    .catch(error => {
                        console.error("API fetch error, loading fallback data:", error);
                        
                        // Fallback sample data
                        const sampleData = [
                            { 
                                wbs_id: "100", 
                                wbs_name: "Project Alpha", 
                                wbs_parent_id: null
                            },
                            { 
                                wbs_id: "101", 
                                wbs_name: "Phase 1: Planning", 
                                wbs_parent_id: "100",
                                activity_id: "A1", 
                                activity_name: "Develop Project Plan", 
                                start_date: "2024-01-02", 
                                duration: 5, 
                                progress: 1, 
                                type: "task" 
                            },
                            { 
                                wbs_id: "101", 
                                wbs_name: "Phase 1: Planning", 
                                wbs_parent_id: "100",
                                activity_id: "A2", 
                                activity_name: "Team Kick-off Meeting", 
                                start_date: "2024-01-07", 
                                duration: 0, 
                                progress: 1, 
                                type: "milestone",
                                rollup: true
                            },
                            { 
                                wbs_id: "102", 
                                wbs_name: "Phase 2: Execution", 
                                wbs_parent_id: "100",
                                activity_id: "B1", 
                                activity_name: "Site Preparation", 
                                start_date: "2024-01-08", 
                                duration: 7, 
                                progress: 0.8, 
                                type: "task" 
                            },
                            { 
                                wbs_id: "102", 
                                wbs_name: "Phase 2: Execution", 
                                wbs_parent_id: "100",
                                activity_id: "B2", 
                                activity_name: "Foundation Work", 
                                start_date: "2024-01-15", 
                                duration: 10, 
                                progress: 0.65, 
                                type: "task" 
                            },
                            { 
                                wbs_id: "103", 
                                wbs_name: "Phase 3: Finishing", 
                                wbs_parent_id: "100",
                                activity_id: "C1", 
                                activity_name: "Interior Work", 
                                start_date: "2024-01-25", 
                                duration: 15, 
                                progress: 0.3, 
                                type: "task",
                                hide_bar: true
                            },
                            { 
                                wbs_id: "103", 
                                wbs_name: "Phase 3: Finishing", 
                                wbs_parent_id: "100",
                                activity_id: "M1", 
                                activity_name: "Project Completion", 
                                start_date: "2024-02-15", 
                                duration: 0, 
                                progress: 0, 
                                type: "milestone",
                                rollup: true
                            }
                        ];
                        
                        const ganttTasks = processGanttData(sampleData);
                        allTasks = ganttTasks.data;
                        renderGantt(ganttTasks);
                        
                        // Auto-expand after data load
                        setTimeout(() => {
                            expandAll();
                            setupFilters();
                        }, 100);
                    });
            }

            // --- Event Handlers ---
            document.getElementById("expand-all-btn").addEventListener("click", expandAll);
            document.getElementById("collapse-all-btn").addEventListener("click", collapseAll);
            document.getElementById("refresh-data-btn").addEventListener("click", loadGanttData);

            // Initial data load
            loadGanttData();
            
            // Ensure Gantt chart resizes with container
            window.addEventListener("resize", function() {
                if (gantt.$container) {
                    gantt.render();
                }
            });
        });
    </script>
</body>
</html>
